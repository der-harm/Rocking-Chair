<!DOCTYPE html>
<!-- 
 This is the page that lists all the feeds to which the user subscribed.
 It should allow for more subscriptions too.
-->
<html>
<head>
    <link rel="stylesheet" href="styles/main.css" type="text/css" />
    <script type="text/javascript" src="scripts/jquery-1.4.3.min.js"></script>
    <script type="text/javascript" src="scripts/jquery.couch.js"></script>
    <script type="text/javascript" src="scripts/jquery.couch.app.js"></script>
    <title>Subscribed feeds</title>
</head>
<body>
    <div id="container">
      <div id="feeds">
        <table id="list">
            <tbody>
                <!-- this is where the feeds will be shown -->
            </tbody>
        </table>
        <h2>Subscribe to a new feed</h2>
        <form id="subscribe">
            <p>
                <label>URL:</label><br />
                <input type="text" name="url" id="url" value="" />
            </p>
            <p>
                <input type="submit">
            </p>
        </form>
      </div>
      <div id="content">
          <!-- this is where the entries will be shown -->
      </div>
    </div>
    
    
    <!--
    Listing all subscribed feeds. 
    -->
    <script>
    
    //
    // Susbcribes to the feed at Superfeedr, using pubsubjubhub.
    function subscribeToFeed(feed) {
        var superfeedr_login    = "couchapp";
        var superfeedr_password = "couchapp1";
        var pubsubjubhub        = "http://pubsubjubhub.appspot.com/"
        var callback            = "http://superfeedr.couchone.com/push/_design/push/_rewrite/feeds/" + feed.id + "/entries";
        var url                 = pubsubjubhub + "?"
            + "hub.url=http://superfeedr.com/hubbub"
            + "&superfeedr.format=json" 
            + "&hub.topic=" + feed.url 
            + "&hub.callback=" + callback 
            + "&superfeedr.login=" + superfeedr_login 
            + "&superfeedr.password=" + superfeedr_password;

        $.ajax({
            url: url,
            dataType: "jsonp",
            success: function(data) {
                if(data.code == "200") {
                    alert("Successfully subscribed");
                }
                else {
                    alert(data.body);
                }
            },
            error: function(request, textStatus, errorThrown) {
                alert("There was an error when trying to subscribe to this feed. " + textStatus);
            }
        });
    }
    
    $.couch.app(function(app){
        // On startup, we need to load all the feeds stored in the couch.
        // Show them, as well as their stories.
        docs = app.db.allDocs({
            success: function(data) {
                for(row in data.rows) {
                    if(data.rows[row].id != "_design/push") {
                        app.db.openDoc(data.rows[row].id, {
                            success: function(feed) {
                                $('#list > tbody:last').append('<tr><td><img src="http://getfavicon.appspot.com/' + feed.url + '" /></td><td>' +  feed.title + '</td></tr>');
                            }
                        })
                    }
                }
            }
        });
        
        // Since couchapps cannot actually HTTP calls (design choice), we need to perform the subscription from the web browser.
        // First, we need to create the feed, and get the id for this feed to build the callback.
        // Once the feed is created, we can then perform the PubSubHubbub subscription.
        // Of course the UI needs some work :) and we may also want to mark the feed when it is subscribed.
        $('#subscribe').submit(function() {

            var feed_url = $('#url').val();

            app.db.saveDoc({
                url: feed_url,
                type: "feed", 
                created_at: new Date().getTime(), 
                updated_at: new Date().getTime(), 
                entries: [] }, {
                success: function(feed) {
                    alert("Feed created! Subscribing now.")
                    subscribeToFeed(feed)
                },
                error: function() {
                    alert("There was an error when adding the feed, please retry");
                } 
            });
            return false;
        });
    });
    
    </script>
</body>
</html>
